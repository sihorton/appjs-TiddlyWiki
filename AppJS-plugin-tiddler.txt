//{{{
/** 
AppJS Support tested with TikiWiki 2.6.5 October 15, 2012
**/
window.allowSave = function()
{
	return (originalPath.substr(0,5) == 'file:');
}

window.saveChanges = function(onlyIfDirty,tiddlers)
{
	if(onlyIfDirty && !store.isDirty())
		return;
	clearMessage();
	var t0 = new Date();
	var msg = config.messages;
	var originalPath = document.location.toString();
	/** AppJS moved test to a function so it can be hijacked **/
	if (!window.allowSave()) { 
		alert(msg.notFileUrlError);
		if(store.tiddlerExists(msg.saveInstructions))
			story.displayTiddler(null,msg.saveInstructions);
		return;
	}
	var localPath = getLocalPath(originalPath);
	var original = loadOriginal(localPath);
	if(original == null) {
		alert(msg.cantSaveError);
		if(store.tiddlerExists(msg.saveInstructions))
			story.displayTiddler(null,msg.saveInstructions);
		return;
	}
	var posDiv = locateStoreArea(original);
	if(!posDiv) {
		alert(msg.invalidFileError.format([localPath]));
		return;
	}
	saveMain(localPath,original,posDiv);
	if(config.options.chkSaveBackups)
		saveBackup(localPath,original);
	if(config.options.chkSaveEmptyTemplate)
		saveEmpty(localPath,original,posDiv);
	if(config.options.chkGenerateAnRssFeed && saveRss instanceof Function)
		saveRss(localPath);
	if(config.options.chkDisplayInstrumentation)
		displayMessage("saveChanges " + (new Date()-t0) + " ms");
}

config.tasks.save.action = window.saveChanges;

if(config.userAgent.indexOf("appjstw") != -1)
{
	// The AppJS browser can always load and save using its external functions.
	window.allowSave = function()
	{
		return true;
	}

    window.getLocalPath = function(fileUrl)
    {
        return window.externalJsPath(fileUrl);
    }

	window.saveFile = function(filePath,content)
	{
		return window.externalJsSave(filePath,content);
	}

	window.loadFile = function(filePath)
	{
		return window.externalJsLoad(filePath);
	}	
}
//}}}
