//{{{
/** 
AppJS Support tested with TikiWiki 2.6.5 October 11, 2012
**/
if(document.location.toString().search("http://appjs/") >= 0) 
{
	window.saveChanges = function(onlyIfDirty,tiddlers)
	{
		if(onlyIfDirty && !store.isDirty())
			return;
		clearMessage();
		var t0 = new Date();
		var msg = config.messages;
		var originalPath = document.location.toString();
		/** AppJS added !window['allowSave']**/
		if ((originalPath.substr(0,5) != 'file:') && !window['allowSave']) { 
			alert(msg.notFileUrlError);
			if(store.tiddlerExists(msg.saveInstructions))
				story.displayTiddler(null,msg.saveInstructions);
			return;
		}

		var localPath = getLocalPath(originalPath);
		var original = loadOriginal(localPath);
		if(original == null) {
			alert(msg.cantSaveError);
			if(store.tiddlerExists(msg.saveInstructions))
				story.displayTiddler(null,msg.saveInstructions);
			return;
		}
		var posDiv = locateStoreArea(original);
		if(!posDiv) {
			alert(msg.invalidFileError.format([localPath]));
			return;
		}
		saveMain(localPath,original,posDiv);
		if(config.options.chkSaveBackups)
			saveBackup(localPath,original);
		if(config.options.chkSaveEmptyTemplate)
			saveEmpty(localPath,original,posDiv);
		if(config.options.chkGenerateAnRssFeed && saveRss instanceof Function)
			saveRss(localPath);
		if(config.options.chkDisplayInstrumentation)
			displayMessage("saveChanges " + (new Date()-t0) + " ms");
	}

	window.saveFile = function(fileUrl,content)
	{
		return window.externalJsSave(fileUrl,content); /** AppJS **/
	}

	window.loadFile = function(fileUrl)
	{
		return window.externalJsLoad(fileUrl); /** AppJS **/
	}
	
	config.tasks.save.action = window.saveChanges;
}
//}}}
